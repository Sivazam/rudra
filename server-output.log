Watching /home/z/my-project and all sub-directories not excluded by your .gitignore. Will not monitor dotfiles.
Found & ignored ./prisma ; is listed in .gitignore
Found & ignored ./skills ; is listed in .gitignore
Found & ignored ./src ; is listed in .gitignore
Found & ignored ./public ; is listed in .gitignore
Found & ignored ./upload ; is listed in .gitignore
Found & ignored ./examples ; is listed in .gitignore
Found & ignored ./node_modules ; is listed in .gitignore
Found & ignored ./.git ; is listed in .gitignore
Found & ignored ./.next ; is listed in .gitignore
Found & ignored ./db ; is listed in .gitignore
Found & ignored ./eslint.config.mjs ; is listed in .gitignore
Found & ignored ./tailwind.config.ts ; is listed in .gitignore
Found & ignored ./components.json ; is listed in .gitignore
Found & ignored ./README.md ; is listed in .gitignore
Found & ignored ./next.config.ts ; is listed in .gitignore
Found & ignored ./package.json ; is listed in .gitignore
Found & ignored ./bun.lock ; is listed in .gitignore
Found & ignored ./tsconfig.json ; is listed in .gitignore
Found & ignored ./postcss.config.mjs ; is listed in .gitignore
Found & ignored ./SECURITY.md ; is listed in .gitignore
Found & ignored ./package-lock.json ; is listed in .gitignore
Found & ignored ./server.ts ; is listed in .gitignore
Found & ignored ./FIREBASE_MIGRATION.md ; is listed in .gitignore
Found & ignored ./server-output.log ; is listed in .gitignore
Found & ignored ./CUSTOMER_ORDERS_POLLING_EXAMPLE.tsx ; is listed in .gitignore
Found & ignored ./worklog.md ; is listed in .gitignore
Found & ignored ./next.log ; is listed in .gitignore
Found & ignored ./next-env.d.ts ; is listed in .gitignore

Starting: server.ts
 ⚠ Runtime config is deprecated and the `serverRuntimeConfig` configuration option will be removed in Next.js 16.
> Ready on http://0.0.0.0:3000
> Socket.IO server running at ws://0.0.0.0:3000/api/socketio
 ○ Compiling /middleware ...
 ✓ Compiled /middleware in 989ms (114 modules)
 ○ Compiling / ...
 ⚠ Fast Refresh had to perform a full reload due to a runtime error.
 ⚠ Fast Refresh had to perform a full reload due to a runtime error.
 ✓ Compiled /order-failed in 16.7s (1360 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET / 200 in 17761ms
 GET /order-failed 200 in 11906ms
 ⚠ Cross origin request detected from preview-chat-fb70fdcd-28df-4d3b-96ce-460f57a59133.space.z.ai to /_next/* resource. In a future major version of Next.js, you will need to explicitly configure "allowedDevOrigins" in next.config to allow this.
Read more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins
 ○ Compiling /favicon.ico ...
 ✓ Compiled /favicon.ico in 1410ms (842 modules)
 GET /favicon.ico 200 in 1584ms
 ○ Compiling /cart ...
 ✓ Compiled /cart in 1305ms (1390 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /cart 200 in 1460ms
 ○ Compiling /my-orders ...
 ✓ Compiled /my-orders in 1571ms (1413 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /my-orders 200 in 1919ms
 ○ Compiling /checkout ...
 ✓ Compiled /checkout in 2.7s (1446 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /checkout 200 in 2952ms
 ○ Compiling /api/payment/create-order ...
 ✓ Compiled /api/payment/create-order in 2.3s (1491 modules)
Payment create-order API called
Request body received: {
  hasItems: true,
  hasShippingAddress: true,
  hasCustomerInfo: true,
  itemCount: 2,
  shippingAddress: {
    name: "sai",
    phone: "+919014882779",
    email: "s@m.com",
    address: "t1,new era road",
    city: "rajahmundry",
    state: "",
    pincode: "560024",
  },
}
Order totals calculated: {
  subtotal: 1299,
  shippingCost: 0,
  total: 1299,
}
Creating Razorpay order with options: {
  amount: 129900,
  currency: "INR",
  receipt: "order_1766774102100",
  payment_capture: 1,
  notes: {
    customer_name: "sai",
    customer_phone: "+919014882779",
    customer_email: "s@m.com",
    order_type: "spiritual_products",
  },
  key_secret: "***",
}
Razorpay order created successfully: order_RwLC4NDuL44xlX
Full Razorpay response: {
  amount: 129900,
  amount_due: 129900,
  amount_paid: 0,
  attempts: 0,
  created_at: 1766774102,
  currency: "INR",
  entity: "order",
  id: "order_RwLC4NDuL44xlX",
  notes: {
    customer_email: "s@m.com",
    customer_name: "sai",
    customer_phone: "+919014882779",
    order_type: "spiritual_products",
  },
  offer_id: null,
  receipt: "order_1766774102100",
  status: "created",
}
Order data prepared for payment verification
 POST /api/payment/create-order 200 in 2838ms
 ○ Compiling /api/payment/verify ...
 ✓ Compiled /api/payment/verify in 3.3s (995 modules)
=== Payment Verify API Called ===
Request body keys: [ "razorpayOrderId", "razorpayPaymentId", "razorpaySignature", "orderData" ]
Razorpay Order ID: order_RwLC4NDuL44xlX
Razorpay Payment ID: pay_RwLCPmVYE9z0DJ
Razorpay Signature: 735fc7087d0de1d71909e7c6e096663d24db7b8a5b7a94df201e7836af5c2311
Order Data: {
  items: [
    {
      productId: "Dhbz23qUzNLMU9ybIjTG",
      variantId: "10 MM",
      name: "Karungali Mala",
      quantity: 1,
      price: 799,
      discount: 0,
      totalPrice: 799,
      image: "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1764874794304_0.webp?alt=media&token=1ad5f71e-9bf4-4f0a-b91e-cb3e43752ce2",
    },
    {
      productId: "SWogCAyT0sw09Su2gTVo",
      variantId: " 8 MM",
      name: "8MM Devadaru Mala",
      quantity: 1,
      price: 500,
      discount: 0,
      totalPrice: 500,
      image: "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1758153405109_0.webp?alt=media&token=2f7975e7-7aa5-4c5b-9b96-7fb69614e6f3",
    }
  ],
  customerInfo: {
    name: "sai",
    phone: "+919014882779",
    email: "s@m.com",
    address: "t1,new era road",
    city: "rajahmundry",
    state: "",
    pincode: "560024",
  },
  subtotal: 1299,
  shippingCost: 0,
  total: 1299,
}
Payment signature verified successfully
Verify: Token verified using Buffer secret
Verify: Authenticated user identifier: {
  phoneNumber: "+919014882779",
  userId: "+919014882779",
  isAuthenticated: true,
}
Creating or updating user for phone: +919014882779
UserService: User updated successfully with phone number as ID: +919014882779
User created/updated with database ID: +919014882779
UserService: Getting user by phone number (document ID): +919014882779
UserService: User found: Yes
Existing user from DB: {
  id: "+919014882779",
  updatedAt: Timestamp {
    seconds: 1766774144,
    nanoseconds: 959000000,
    toDate: [Function: toDate],
    toMillis: [Function: toMillis],
    _compareTo: [Function: _compareTo],
    isEqual: [Function: isEqual],
    toString: [Function: toString],
    toJSON: [Function: toJSON],
    valueOf: [Function: valueOf],
  },
  name: "sai",
  city: "rajahmundry",
  address: "t1,new era road",
  addresses: [
    {
      email: "s@m.com",
      createdAt: "2025-12-26T18:28:52.585Z",
      addressType: "home",
      customAddressName: "",
      city: "rajahmundry",
      phone: "+919014882779",
      id: "addr_1766773732585",
      name: "sai",
      pincode: "560024",
      isDefault: true,
      doorNo: "t1,new era road",
      landmark: "",
    }
  ],
  state: "",
  pincode: "560024",
  orderIds: [
    "i78WsXVaR86Gm5fpvBDU", "znrgHr0xucbGejyFcznM", "DMyERcoc57C1MBf4S2nm", "qpoUrzIhh5bGiJbuXCYB",
    "3GLwzaDACbHmqrBNYJba", "sxHpx2aabhRLjXnGjUES", "C6RiWE21O555Dp2pvLO2", "7Kex1CunYK4klRLBnAvu",
    "LAOhczOvRVvLTZEK6Zuy", "M6MFFKc4CRC6rjegGQwm", "wcBRi8BNdmsVvbj3MrSz", "AFYgmGEm5MEtH9CeLYmO",
    "v7rKO1JIfGUF5JvFgNMC", "TwhmaCisLj7DJp9PsuON", "7knTILLUndAXyKmL3sBu", "eHQF8baHi9bgkuG7xf6z",
    "HSLBH5kWgbc8N2ixZfkJ", "LOUVmfYvKxGvk10O2vfj"
  ],
  email: "s@m.com",
  phoneNumber: "+919014882779",
  wishlist: [
    {
      deity: "Lord Shiva",
      hasVariants: true,
      name: "8MM Devadaru Mala",
      id: "wishlist_1758442211656_oldq9r099",
      addedAt: "2025-09-21T08:10:11.656Z",
      categoryName: "Rudraksha Mala",
      image: "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1758153405109_0.webp?alt=media&token=2f7975e7-7aa5-4c5b-9b96-7fb69614e6f3",
      originalPrice: 1100,
      variants: [
        [Object ...]
      ],
      productId: "SWogCAyT0sw09Su2gTVo",
      price: 500,
    }, {
      variants: [
        [Object ...]
      ],
      price: 200,
      deity: "Lord Hanuman &  Lord Shiva",
      productId: "B548LXmxITrXeEa69LGB",
      name: "8MM Karungali Rudraksha Bracelet",
      categoryName: "Bracelets",
      id: "wishlist_1758442223110_zue9dqs0u",
      hasVariants: true,
      image: "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1758153112273_0.webp?alt=media&token=7fdb087a-340e-4820-8516-0a80a8200dd8",
      originalPrice: 800,
      addedAt: "2025-09-21T08:10:23.110Z",
    }
  ],
  createdAt: "2025-09-18T10:53:35.829Z",
}
Existing addresses count: 1
New address string for comparison: t1,new era road, rajahmundry,  - 560024
Comparing address #1: existing="undefined, rajahmundry, undefined - 560024" vs new="t1,new era road, rajahmundry,  - 560024", match: false
Address exists check result: false
Adding new address to user profile...
New address added to user profile successfully
User created/updated successfully: +919014882779
Creating order in database...
OrderService: Creating order with data: {
  userId: "+919014882779",
  itemCount: 2,
  total: 1299,
}
OrderService: Creating document in Firestore...
OrderService: Order data to create: {
  "userId": "+919014882779",
  "customerInfo": {
    "name": "sai",
    "phone": "+919014882779",
    "email": "s@m.com",
    "address": "t1,new era road",
    "city": "rajahmundry",
    "state": "",
    "pincode": "560024"
  },
  "items": [
    {
      "productId": "Dhbz23qUzNLMU9ybIjTG",
      "variantId": "10 MM",
      "name": "Karungali Mala",
      "quantity": 1,
      "price": 799,
      "discount": 0,
      "totalPrice": 799,
      "image": "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1764874794304_0.webp?alt=media&token=1ad5f71e-9bf4-4f0a-b91e-cb3e43752ce2"
    },
    {
      "productId": "SWogCAyT0sw09Su2gTVo",
      "variantId": " 8 MM",
      "name": "8MM Devadaru Mala",
      "quantity": 1,
      "price": 500,
      "discount": 0,
      "totalPrice": 500,
      "image": "https://firebasestorage.googleapis.com/v0/b/rudra-bb6b7.firebasestorage.app/o/products%2Frudra%2F1758153405109_0.webp?alt=media&token=2f7975e7-7aa5-4c5b-9b96-7fb69614e6f3"
    }
  ],
  "subtotal": 1299,
  "shippingCost": 0,
  "total": 1299,
  "razorpayOrderId": "order_RwLC4NDuL44xlX",
  "razorpayPaymentId": "pay_RwLCPmVYE9z0DJ",
  "razorpaySignature": "735fc7087d0de1d71909e7c6e096663d24db7b8a5b7a94df201e7836af5c2311",
  "status": "pending",
  "paymentStatus": "completed",
  "orderDate": "2025-12-26T18:35:45.389Z",
  "paidAt": "2025-12-26T18:35:45.389Z",
  "orderNumber": "RUD74145389"
}
Firestore: Creating document in collection orders
Firestore: Document created with ID pYMxViV8SJ5iz4Uc58F5
OrderService: Order created successfully with ID: pYMxViV8SJ5iz4Uc58F5
OrderService: Order should be associated with userId: +919014882779
NotificationService: Creating notification: New Order Received
Firestore: Creating document in collection notifications
Firestore: Error creating document: Error [FirebaseError]: Function addDoc() called with invalid data. Unsupported field value: undefined (found in field data.orderNumber in document notifications/Inti4rX3mMYoKeDr2nfZ)
    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:18:108)
    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:10:34)
    at createOrderNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:131:39)
    at createOrder (webpack-internal:///(rsc)/./src/lib/services/orderService.ts:39:116)
    at processTicksAndRejections (null) {
  code: 'invalid-argument',
  customData: undefined,
  toString: [Function (anonymous)]
}
Firestore: Error details: {
  name: "FirebaseError",
  message: "Function addDoc() called with invalid data. Unsupported field value: undefined (found in field data.orderNumber in document notifications/Inti4rX3mMYoKeDr2nfZ)",
  stack: "FirebaseError: Function addDoc() called with invalid data. Unsupported field value: undefined (found in field data.orderNumber in document notifications/Inti4rX3mMYoKeDr2nfZ)\n    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:18:108)\n    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:10:34)\n    at createOrderNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:131:39)\n    at createOrder (webpack-internal:///(rsc)/./src/lib/services/orderService.ts:39:116)\n    at processTicksAndRejections (native)",
  code: "invalid-argument",
}
NotificationService: Error creating notification: Error: Failed to create document: Function addDoc() called with invalid data. Unsupported field value: undefined (found in field data.orderNumber in document notifications/Inti4rX3mMYoKeDr2nfZ)
    at <anonymous> (webpack-internal:///(rsc)/./src/lib/firebase.ts:63:19)
    at create (webpack-internal:///(rsc)/./src/lib/firebase.ts:35:24)
    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:18:108)
    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:10:34)
    at createOrderNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:131:39)
    at createOrder (webpack-internal:///(rsc)/./src/lib/services/orderService.ts:39:116)
    at processTicksAndRejections (null)
OrderService: Failed to create notification: Error: Failed to create notification: Failed to create document: Function addDoc() called with invalid data. Unsupported field value: undefined (found in field data.orderNumber in document notifications/Inti4rX3mMYoKeDr2nfZ)
    at createNotification (webpack-internal:///(rsc)/./src/lib/services/notificationService.ts:23:19)
    at processTicksAndRejections (null)
Order created successfully: pYMxViV8SJ5iz4Uc58F5 with userId: +919014882779
Associating order with user: +919014882779 orderId: pYMxViV8SJ5iz4Uc58F5 isAuthenticated: true
UserService: Adding order pYMxViV8SJ5iz4Uc58F5 to user +919014882779
UserService: User found, current orderIds: [
  "i78WsXVaR86Gm5fpvBDU", "znrgHr0xucbGejyFcznM", "DMyERcoc57C1MBf4S2nm", "qpoUrzIhh5bGiJbuXCYB",
  "3GLwzaDACbHmqrBNYJba", "sxHpx2aabhRLjXnGjUES", "C6RiWE21O555Dp2pvLO2", "7Kex1CunYK4klRLBnAvu",
  "LAOhczOvRVvLTZEK6Zuy", "M6MFFKc4CRC6rjegGQwm", "wcBRi8BNdmsVvbj3MrSz", "AFYgmGEm5MEtH9CeLYmO",
  "v7rKO1JIfGUF5JvFgNMC", "TwhmaCisLj7DJp9PsuON", "7knTILLUndAXyKmL3sBu", "eHQF8baHi9bgkuG7xf6z",
  "HSLBH5kWgbc8N2ixZfkJ", "LOUVmfYvKxGvk10O2vfj"
]
UserService: Adding order ID to user, new orderIds: [
  "i78WsXVaR86Gm5fpvBDU", "znrgHr0xucbGejyFcznM", "DMyERcoc57C1MBf4S2nm", "qpoUrzIhh5bGiJbuXCYB",
  "3GLwzaDACbHmqrBNYJba", "sxHpx2aabhRLjXnGjUES", "C6RiWE21O555Dp2pvLO2", "7Kex1CunYK4klRLBnAvu",
  "LAOhczOvRVvLTZEK6Zuy", "M6MFFKc4CRC6rjegGQwm", "wcBRi8BNdmsVvbj3MrSz", "AFYgmGEm5MEtH9CeLYmO",
  "v7rKO1JIfGUF5JvFgNMC", "TwhmaCisLj7DJp9PsuON", "7knTILLUndAXyKmL3sBu", "eHQF8baHi9bgkuG7xf6z",
  "HSLBH5kWgbc8N2ixZfkJ", "LOUVmfYvKxGvk10O2vfj", "pYMxViV8SJ5iz4Uc58F5"
]
UserService: Order successfully added to user
Order associated with user successfully
 POST /api/payment/verify 200 in 5548ms
 ○ Compiling /order-success ...
 ✓ Compiled /order-success in 1941ms (1497 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /order-success 200 in 2236ms
 ○ Compiling /my-orders ...
 ✓ Compiled /my-orders in 1004ms (1125 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /my-orders 200 in 1087ms
 ○ Compiling /my-orders/[orderNumber] ...
 ✓ Compiled /my-orders/[orderNumber] in 3.5s (1710 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /my-orders/RUD74145389 200 in 4188ms
 ○ Compiling /api/orders/by-user ...
 ✓ Compiled /api/orders/by-user in 1914ms (1710 modules)
Orders by-user API called
Orders by-user: Token verified using Buffer secret
Orders by-user: Authenticated user: {
  phoneNumber: "+919014882779",
  userId: "+919014882779",
  isAuthenticated: true,
}
Orders by-user: Fetching orders for userId: +919014882779
OrderService: Getting orders for userId: +919014882779
OrderService: Query parameters: {
  collection: "orders",
  where: {
    field: "userId",
    operator: "==",
    value: "+919014882779",
  },
  orderBy: {
    field: "orderDate",
    direction: "desc",
  },
}
OrderService: Query with orderBy failed, trying without orderBy: [Error [FirebaseError]: The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/rudra-bb6b7/firestore/indexes?create_composite=Ckpwcm9qZWN0cy9ydWRyYS1iYjZiNy9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvb3JkZXJzL2luZGV4ZXMvXxABGgoKBnVzZXJJZBABGg0KCW9yZGVyRGF0ZRACGgwKCF9fbmFtZV9fEAI] {
  code: 'failed-precondition',
  customData: undefined,
  toString: [Function (anonymous)]
}
OrderService: Found 8 orders without orderBy
OrderService: Orders sorted manually
OrderService: Final orders count: 8
OrderService: First order sample: {
  id: "pYMxViV8SJ5iz4Uc58F5",
  orderNumber: "RUD74145389",
  userId: "+919014882779",
  status: "pending",
}
Orders by-user: Found 8 orders
 GET /api/orders/by-user 200 in 3618ms
 ○ Compiling /addresses ...
 ✓ Compiled /addresses in 3s (1724 modules)
 ⚠ metadataBase property in metadata export is not set for resolving social open graph or twitter images, using "http://localhost:3000". See https://nextjs.org/docs/app/api-reference/functions/generate-metadata#metadatabase
 GET /addresses 200 in 3180ms
